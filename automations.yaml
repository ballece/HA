# Smart Battery Control with Huawei forcible mode awareness
# Single control loop: evaluate every 15 minutes only
# Guard: do NOT start forcible discharge when PV is naturally charging (battery charge_discharge_power > 0)
# Uses huawei_solar.stop_forcible_charge to stop both charge and discharge

- id: 'battery_control_loop_15min'
  alias: Battery Control Loop (15m)
  description: Evaluate price/SOC and start/stop forcible modes appropriately every 15 minutes
  trigger:
    - platform: time_pattern
      minutes: "/15"
  condition: []
  action:
    - choose:
        # Start forcible charging if allowed, not already forcing charge, not currently forcing discharge, and not increasing normaltariff
        - conditions:
            - condition: state
              entity_id: sensor.charge_allowed_now
              state: "True"
            - condition: state
              entity_id: sensor.is_forcible_charging
              state: "False"
            - condition: state
              entity_id: sensor.is_forcible_discharging
              state: "False"
            # Check if current hourly import + 15 min of 3 kW battery charge + 15 min of 2 kW other use would increase normaltariff
            - condition: template
              value_template: >
                {{ (states('sensor.filtered_hourly_import') | float(0) + 0.25*3 + 0.25*2) <= states('input_number.normaltariff') | float(0) }}
          sequence:
            - service: huawei_solar.forcible_charge
              data:
                power: "3000"
                device_id: 898980bfd3e211f7d2b52da0aeee8a91
                duration: 15
        # Block: Normaltariff would be increased, send notification
        - conditions:
            - condition: template
              value_template: >
                {{ (states('sensor.filtered_hourly_import') | float(0) + 0.25*3 + 0.25*2) > states('input_number.normaltariff') | float(0) }}
          sequence:
            - service: persistent_notification.create
              data:
                title: "Normaltariff block"
                message: >
                  Charged 0.75â€¯kWh would raise import above normaltariff. Import: {{ states('sensor.filtered_hourly_import') }},
                  Normaltariff: {{ states('input_number.normaltariff') }}
 

        # Start forcible discharging if allowed, not already forcing discharge, not currently forcing charge,
        # and only when PV is NOT naturally charging (i.e., charge_discharge_power <= 0)
        - conditions:
            - condition: state
              entity_id: sensor.discharge_allowed_now
              state: "True"
            - condition: state
              entity_id: sensor.is_forcible_discharging
              state: "False"
            - condition: state
              entity_id: sensor.is_forcible_charging
              state: "False"
            - condition: numeric_state
              entity_id: sensor.batteries_charge_discharge_power
              below: 0
          sequence:
            - service: huawei_solar.forcible_discharge_soc
              data:
                target_soc: "{{ (states('input_number.min_soc') | float(5)) | int }}"
                power: "3000"
                device_id: 898980bfd3e211f7d2b52da0aeee8a91
      default:
        # If neither allowed, ensure forcible modes are stopped (but don't interfere with natural PV charging)
        - choose:
            - conditions:
                - condition: state
                  entity_id: sensor.is_forcible_charging
                  state: "True"
              sequence:
                - service: huawei_solar.stop_forcible_charge
                  data:
                    device_id: 898980bfd3e211f7d2b52da0aeee8a91
            - conditions:
                - condition: state
                  entity_id: sensor.is_forcible_discharging
                  state: "True"
              sequence:
                - service: huawei_solar.stop_forcible_charge
                  data:
                    device_id: 898980bfd3e211f7d2b52da0aeee8a91


## Update buy and sell thresholds
- alias: "Update Buy Threshold Based on Buy Cost and Margin"
  trigger:
    - platform: time
      at: "00:15:00"
    - platform: state
      entity_id: input_number.desired_profit_margin
    - platform: state
      entity_id: input_number.elspot_monthly_average
    - platform: state
      entity_id: sensor.elpris_buy_kostnad
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.buy_threshold_ore
      data:
        value: >
          {% set v = (states('sensor.elpris_buy_kostnad') | float(0)) -
                     (states('input_number.desired_profit_margin') | float(0)) %}
          {% set v_min = state_attr('input_number.buy_threshold_ore','min') %}
          {% set v_max = state_attr('input_number.buy_threshold_ore','max') %}
          {{ [v_max, [v_min, v]|max]|min }}

- alias: "Update Sell Threshold Based on Cost"
  trigger:
    - platform: time
      at: "00:20:00"
    - platform: state
      entity_id: input_number.desired_profit_margin
    - platform: state
      entity_id: sensor.elpris_ore_current
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.sell_threshold_ore
      data:
        value: >
          {% set v = (states('sensor.elpris_ore_current') | float(0)) %}
          {% set v_min = state_attr('input_number.sell_threshold_ore','min') %}
          {% set v_max = state_attr('input_number.sell_threshold_ore','max') %}
          {{ [v_max, [v_min, v]|max]|min }}


## Normaltariff automations
- alias: "Update Normaltariff"
  trigger:
    - platform: state
      entity_id: sensor.filtered_hourly_import
  condition:
    - condition: template
      value_template: >
        {{ states('sensor.filtered_hourly_import') | float(0) > states('input_number.normaltariff') | float(0) }}
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.normaltariff
      data:
        value: "{{ states('sensor.filtered_hourly_import') | float(0) }}"

- alias: "Reset Normaltariff"
  trigger:
    - platform: time
      at: "00:00:00"
  condition:
    - condition: template
      value_template: "{{ now().day == 1 }}"
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.normaltariff
      data:
        value: 0


## Monthly average spot price automations
- alias: "Update Monthly Average with Today's Spot"
  trigger:
    - platform: time
      at: '00:05:00'
  condition:
    - condition: template
      value_template: "{{ now().day != 1 }}"
  action:
    - variables:
        # Today's 15-min spot prices from sensor.elpriser_idag attribute
        prices: >
          {% set attrs = state_attr('sensor.elpriser_idag', 'values') %}
          {{ attrs if attrs is iterable else [] }}
        todays_avg: >
          {% if prices and prices|length > 0 %}
            {{ (prices | map('float') | list | sum) / (prices | length) }}
          {% else %}
            0
          {% endif %}
        prev_avg: "{{ states('input_number.elspot_monthly_average') | float(0) }}"
        prev_days: "{{ now().day - 1 }}"
        new_days: "{{ prev_days + 1 }}"
        new_avg: >
          {% if prev_days > 0 %}
            {{ ((prev_avg * prev_days) + todays_avg) / new_days }}
          {% else %}
            {{ todays_avg }}
          {% endif %}
    - service: input_number.set_value
      target:
        entity_id: input_number.elspot_monthly_average
      data:
        value: "{{ new_avg }}"

- alias: "Reset Elspot Monthly Average"
  trigger:
    - platform: time
      at: '00:01:00'
  condition:
    - condition: template
      value_template: "{{ now().day == 1 }}"
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.elspot_monthly_average
      data:
        value: 0
