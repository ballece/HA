- triggers:
    - platform: time_pattern
      minutes: 5    # Check every hour, 5 minutes past
    - trigger: homeassistant
      event: start
  conditions:
    - condition: template   # Only retreive data if the sensor is empty or date is not today
      value_template: >
        {% set prices = state_attr('sensor.elpriser_idag', 'data') %}
        {% if prices is none or prices == [] %}
          true
        {% else %}
          {% set first_date = prices[0].start[:10] %}
          {{ first_date != now().date().isoformat() }}
        {% endif %}
  actions:
    - action: nordpool.get_prices_for_date
      data:
        config_entry: 01JFZZ98CERMRTWQQ92NR5PD56
        date: "{{ now().date() }}"
        areas: SE3
        currency: SEK   # Datan kommer dock som milli-SEK
      response_variable: today_prices
  sensor:
    - name: "Elpriser idag"
      unique_id: elpriser_idag
      unit_of_measurement: "öre/kWh"
      icon: mdi:meter-electric
      state: >
        {% if today_prices is mapping and today_prices['SE3'] is iterable and today_prices['SE3'] | length > 0 %}
          {% set data = namespace(prices=[]) %}
          {% for state in today_prices['SE3'] %}
            {% set data.prices = data.prices + [(state.price / 10) | round(1, default=0)] %}
          {% endfor %}
          {{ min(data.prices) }}
        {% else %}
          0
        {% endif %}
      attributes:
        data: >
          {% if today_prices is mapping and today_prices['SE3'] is iterable and today_prices['SE3'] | length > 0 %}
            {% set data = namespace(prices=[]) %}
            {% for state in today_prices['SE3'] %}
              {% set corrected_start = as_datetime(state.start).astimezone().strftime('%Y-%m-%d %H:%M:%S') %}
              {% set corrected_end = as_datetime(state.end).astimezone().strftime('%Y-%m-%d %H:%M:%S') %}
              {% set data.prices = data.prices + [{'start':corrected_start, 'end':corrected_end, 'price': (state.price / 10) | round(1, default=0)}] %}
            {% endfor %}
            {{ data.prices }}
          {% else %}
            []
          {% endif %}
#        prices: "{{ today_prices['SE3'] if today_prices is defined else [] }}"     # Funkar men tiderna är lite knas
        availability: "{{ today_prices is defined }}"
        last_updated: "{{ now().isoformat() }}"
